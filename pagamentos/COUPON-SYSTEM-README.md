# Sistema de Cup√µes de Desconto - BE WATER

Sistema de refer√™ncia que permite a s√≥cios atuais ou cup√µes gen√©ricos darem **50% de desconto** na pr√≥xima mensalidade (tanto para o novo s√≥cio como para o referenciador).

## üìã √çndice

1. [Como Funciona](#como-funciona)
2. [Setup Inicial](#setup-inicial)
3. [Gest√£o de Cup√µes](#gest√£o-de-cup√µes)
4. [Fluxo do Utilizador](#fluxo-do-utilizador)
5. [Troubleshooting](#troubleshooting)

---

## üéØ Como Funciona

### Arquitetura

```
Frontend (GitHub Pages) ‚Üí Supabase (valida√ß√£o) ‚Üí Formspark (notifica√ß√µes)
```

**Stack:**
- **Frontend:** HTML + JavaScript puro (sem build, sem Node.js)
- **Database:** Supabase (PostgreSQL com RLS)
- **Notifications:** Formspark (email para bewaterlisboa@gmail.com)

### Fluxo Completo (Simplificado)

1. **User abre modal de subscri√ß√£o** (Elite/Rise/Starter)
2. **Pr√©-Form:** Opcionalmente insere cup√£o (email de s√≥cio ou c√≥digo gen√©rico)
3. **Valida√ß√£o:** Sistema verifica cup√£o no Supabase em tempo real
4. **Notifica√ß√£o Imediata:** Se v√°lido, email autom√°tico enviado para staff via Formspark
5. **REGYFIT:** User completa inscri√ß√£o normal no iframe REGYFIT (paga valor COMPLETO)
6. **Staff:** Aplica **50% desconto na PR√ìXIMA mensalidade** para ambos (novo s√≥cio + referenciador)

**IMPORTANTE:** O desconto √© aplicado na **PR√ìXIMA mensalidade**, n√£o na primeira. O user paga valor completo na inscri√ß√£o inicial.

---

## üöÄ Setup Inicial

### 1. Configurar Supabase

#### 1.1 Criar Projeto Supabase

1. Ir a [supabase.com](https://supabase.com)
2. Criar novo projeto
3. Guardar credenciais:
   - **URL:** `https://xxxx.supabase.co`
   - **ANON_KEY:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

#### 1.2 Executar SQL Setup

1. Ir ao **SQL Editor** no dashboard Supabase
2. Abrir o ficheiro `supabase-coupons-setup.sql`
3. Copiar **todo o conte√∫do**
4. Colar no SQL Editor
5. Clicar **Run**

Isto cria:
- Tabela `coupons` (armazena cup√µes v√°lidos)
- Tabela `coupon_usages` (hist√≥rico de utiliza√ß√µes)
- Row Level Security (RLS) para seguran√ßa
- √çndices para performance

#### 1.3 Atualizar index.html com Credenciais

Abrir `index.html` e substituir:

```javascript
const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
```

Por:

```javascript
const SUPABASE_URL = 'https://xxxx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
```

### 2. Verificar Formspark

O form Formspark j√° est√° configurado:
- **Form ID:** `cMzqixKrn`
- **Email destino:** bewaterlisboa@gmail.com

Se precisares de alterar, editar em `src/js/coupons.js`:

```javascript
const COUPON_CONFIG = {
  FORMSPARK_ID: 'cMzqixKrn', // Alterar aqui
  // ...
};
```

### 3. Importar Emails de S√≥cios

#### Op√ß√£o A: Via SQL (recomendado)

1. Abrir Excel com emails dos s√≥cios
2. Abrir ficheiro `member-emails-import.sql`
3. Substituir os emails de exemplo pelos emails reais:

```sql
INSERT INTO coupons (code, type, active) VALUES
  ('socio1@gmail.com', 'member_email', true),
  ('socio2@hotmail.com', 'member_email', true),
  ('socio3@yahoo.com', 'member_email', true)
  -- ... adicionar mais
ON CONFLICT (code) DO NOTHING;
```

4. Executar no SQL Editor do Supabase

#### Op√ß√£o B: F√≥rmula Excel para Gerar SQL

Na c√©lula B1 do Excel (assumindo emails na coluna A):

```
="('"&A1&"', 'member_email', true),"
```

Arrastar para baixo, copiar coluna B, colar no SQL.

---

## üéüÔ∏è Gest√£o de Cup√µes

### Ver Todos os Cup√µes

```sql
SELECT * FROM coupons ORDER BY created_at DESC;
```

### Ver Apenas Ativos

```sql
SELECT * FROM coupons WHERE active = true ORDER BY type, code;
```

### Adicionar Novo Email de S√≥cio

```sql
INSERT INTO coupons (code, type, active) VALUES
  ('novo.socio@email.com', 'member_email', true);
```

### Adicionar Cup√£o Gen√©rico

```sql
INSERT INTO coupons (code, type, active) VALUES
  ('PROMO2025', 'generic', true);
```

### Desativar Cup√£o (sem apagar)

```sql
UPDATE coupons SET active = false WHERE code = 'socio@email.com';
```

### Reativar Cup√£o

```sql
UPDATE coupons SET active = true WHERE code = 'socio@email.com';
```

### Apagar Cup√£o Permanentemente

```sql
DELETE FROM coupons WHERE code = 'socio@email.com';
```

---

## üìä Relat√≥rios e Estat√≠sticas

### Ver Utiliza√ß√µes de Cup√µes

```sql
SELECT * FROM coupon_usages ORDER BY used_at DESC;
```

### Cup√µes Mais Utilizados

```sql
SELECT 
  cu.coupon_code, 
  c.type, 
  COUNT(*) as vezes_usado
FROM coupon_usages cu
LEFT JOIN coupons c ON cu.coupon_code = c.code
GROUP BY cu.coupon_code, c.type
ORDER BY vezes_usado DESC
LIMIT 10;
```

### Utiliza√ß√µes por Plano

```sql
SELECT plan_type, COUNT(*) as total
FROM coupon_usages
GROUP BY plan_type
ORDER BY total DESC;
```

### Utiliza√ß√µes nos √öltimos 30 Dias

```sql
SELECT DATE(used_at) as dia, COUNT(*) as utilizacoes
FROM coupon_usages
WHERE used_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(used_at)
ORDER BY dia DESC;
```

### Total de Descontos a Aplicar

```sql
-- Cada utiliza√ß√£o = 2 descontos (novo s√≥cio + referenciador)
SELECT COUNT(*) * 2 as total_descontos_pendentes
FROM coupon_usages
WHERE notification_sent = false;
```

---

## üë§ Fluxo do Utilizador (Frontend)

### 1. Utilizador Abre Modal de Subscri√ß√£o

- Clica em "INSCREVE-TE" num dos planos (Elite, Rise, Starter)
- Modal abre com **pr√©-form de cup√£o**

### 2. Pr√©-Form: Valida√ß√£o de Cup√£o

**Op√ß√£o A:** Tem cup√£o
1. Insere email de s√≥cio ou c√≥digo gen√©rico (ex: `socio@email.com` ou `PROMO2025`)
2. Clica "VALIDAR CUP√ÉO"
3. Sistema consulta Supabase em tempo real
4. Se v√°lido: 
   - Mensagem verde "‚úÖ Cup√£o v√°lido! Email enviado para staff"
   - Email enviado automaticamente via Formspark para bewaterlisboa@gmail.com
   - Uso guardado na tabela `coupon_usages`
   - Bot√£o "CONTINUAR PARA INSCRI√á√ÉO" aparece
5. User v√™ explica√ß√£o: **"Pagas valor COMPLETO agora, desconto 50% na PR√ìXIMA mensalidade"**

**Op√ß√£o B:** N√£o tem cup√£o
1. Clica "N√ÉO TENHO CUP√ÉO"
2. Vai direto para REGYFIT

### 3. REGYFIT: Inscri√ß√£o Normal

- Iframe REGYFIT carrega
- User preenche dados normalmente (nome, email, telefone, etc.)
- Completa inscri√ß√£o e **paga valor COMPLETO** (primeira mensalidade + taxa inscri√ß√£o)
- **Fim do fluxo online** - n√£o h√° mais pop-ups ou formul√°rios

### 4. Staff Aplica Desconto Manualmente

- Staff recebe email com cup√£o usado
- Na pr√≥xima cobran√ßa mensal:
  - **Novo s√≥cio:** 50% desconto
  - **S√≥cio referenciador:** 50% desconto
- Ambos pagam metade do valor na segunda mensalidade

---

## üìß Email de Notifica√ß√£o (Simplificado)

Quando um cup√£o √© validado, o staff recebe email autom√°tico via Formspark:

```
Para: bewaterlisboa@gmail.com
Assunto: üéüÔ∏è Novo Cup√£o Utilizado - Elite

üéüÔ∏è CUP√ÉO USADO:
C√≥digo: maria@socio.com
Tipo: Email de S√≥cio
Plano: Elite

üí∞ AC√á√ÉO NECESS√ÅRIA:
1. Aguardar inscri√ß√£o REGYFIT completar
2. Identificar novo s√≥cio no sistema REGYFIT
3. Aplicar 50% desconto na PR√ìXIMA mensalidade:
   - Novo s√≥cio
   - S√≥cio maria@socio.com (referenciador)
```

**NOTA:** Os dados do novo s√≥cio (nome, telefone) s√£o capturados pelo REGYFIT e ficam dispon√≠veis no sistema de gest√£o do gin√°sio.

**Staff deve:**
1. Consultar REGYFIT para identificar nova inscri√ß√£o recente no plano mencionado
2. Aplicar 50% desconto ao novo s√≥cio (na PR√ìXIMA mensalidade)
3. Aplicar 50% desconto ao s√≥cio referenciador (na PR√ìXIMA mensalidade)
4. Marcar como conclu√≠do

---

## üîß Troubleshooting

### Cup√£o n√£o valida

**Problema:** Ao inserir cup√£o, d√° erro ou n√£o valida.

**Solu√ß√µes:**
1. Verificar se Supabase est√° configurado no `index.html`
2. Abrir DevTools (F12) ‚Üí Console ‚Üí ver erros
3. Verificar se cup√£o existe e est√° ativo:
   ```sql
   SELECT * FROM coupons WHERE code = 'email@teste.com';
   ```
4. Verificar RLS policies no Supabase

### Email de notifica√ß√£o n√£o chega

**Problema:** Cup√£o √© registado mas email n√£o chega.

**Solu√ß√µes:**
1. Verificar Form ID Formspark em `src/js/coupons.js`
2. Ver se email foi para SPAM
3. Verificar logs no Formspark dashboard
4. Testar Formspark manualmente

### Modal n√£o mostra pr√©-form

**Problema:** Modal abre direto no REGYFIT, sem cup√£o.

**Solu√ß√µes:**
1. Verificar se ficheiro `src/js/coupons.js` est√° carregado
2. Abrir DevTools ‚Üí Console ‚Üí procurar erros JavaScript
3. Verificar se CSS foi carregado (procurar por `.coupon-pre-form` nos estilos)

### Dados n√£o s√£o guardados no Supabase

**Problema:** Cup√£o valida mas n√£o guarda utiliza√ß√£o.

**Solu√ß√µes:**
1. Verificar RLS policy de INSERT na tabela `coupon_usages`
2. Ver logs no Supabase: Settings ‚Üí Logs ‚Üí Database
3. Verificar se ANON_KEY est√° correto

---

## üîí Seguran√ßa

### Por que a ANON_KEY est√° no c√≥digo?

A chave `ANON_KEY` do Supabase √© p√∫blica por design. A seguran√ßa vem do **Row Level Security (RLS)**:

- **Leitura:** Apenas cup√µes **ativos** podem ser lidos
- **Escrita:** Apenas **inser√ß√µes** na tabela `coupon_usages`
- **Admin:** Modificar cup√µes requer `service_role` key (secreta)

### Teste de Seguran√ßa

Tentar modificar cup√£o via browser console:

```javascript
// Isto DEVE FALHAR por causa do RLS
await supabase.from('coupons').delete().eq('code', 'teste@email.com');
// Erro: "permission denied"
```

---

## üöÄ Deploy

### GitHub Pages

1. Fazer commit de todos os ficheiros
2. Push para GitHub
3. GitHub Pages serve automaticamente
4. **Tudo funciona!** ‚úÖ

### Netlify (alternativa)

1. Conectar repo ao Netlify
2. Build settings: nenhum (site est√°tico)
3. Deploy!

---

## üìù Manuten√ß√£o Regular

### Semanal

1. Ver emails de notifica√ß√£o
2. Aplicar descontos
3. Atualizar lista de emails de s√≥cios (se necess√°rio)

### Mensal

1. Ver relat√≥rio de utiliza√ß√µes:
   ```sql
   SELECT * FROM coupon_usages 
   WHERE used_at >= DATE_TRUNC('month', NOW());
   ```
2. Desativar cup√µes expirados (se aplic√°vel)
3. Limpar utiliza√ß√µes antigas (opcional)

---

## üí° Ideias Futuras

- [ ] Dashboard admin para gerir cup√µes (sem SQL)
- [ ] Limites de utiliza√ß√£o por cup√£o
- [ ] Cup√µes com data de expira√ß√£o
- [ ] Descontos vari√°veis (n√£o apenas 50%)
- [ ] Integra√ß√£o direta com REGYFIT API (se dispon√≠vel)

---

## üìû Suporte

**Problemas t√©cnicos:**
- Ver sec√ß√£o [Troubleshooting](#troubleshooting)
- Logs do Supabase: Settings ‚Üí Logs
- Logs do Formspark: Dashboard ‚Üí Forms ‚Üí cMzqixKrn

**D√∫vidas sobre o sistema:**
- Reler esta documenta√ß√£o
- Verificar ficheiros SQL comentados
- Testar num ambiente de staging primeiro

---

**Sistema implementado em:** 2025  
**Vers√£o:** 1.0  
**Stack:** HTML + JavaScript + Supabase + Formspark  
**Compatibilidade:** 100% GitHub Pages ‚úÖ

